
	1.	**GitHub assets/mg-chat.js**ì— ë„£ëŠ” ì½”ë“œ
	2.	**Replit main.py**ì— ë„£ëŠ” ì½”ë“œ (/api/escalate)

â¸»

(3) âœ… mg-chat.js ë³µë¶™ ì½”ë“œ

ëª©í‘œ
	â€¢	ì„œë²„ ì‘ë‹µì— suggest_escalation: trueê°€ ì˜¤ë©´
ğŸ‘‰ ì±„íŒ… ì•ˆì— ì¡°ìš©í•œ ì½œë°± ì•ˆë‚´ ì¹´ë“œ + ì „í™”ë²ˆí˜¸ ì…ë ¥ í¼ì„ ë„ì›€
	â€¢	ì‚¬ìš©ìê°€ â€œìš”ì²­í•˜ê¸°â€ ëˆ„ë¥´ë©´ /api/escalateë¡œ POST

â¸»

3-1) ìƒë‹¨ ì„¤ì •ê°’ ì¶”ê°€

mg-chat.js ìƒë‹¨ì— MG_BASEê°€ ìˆì§€? ê·¸ ì•„ë˜ì— ì´ê²ƒì„ ì¶”ê°€í•´.

// âœ… Replit API ë² ì´ìŠ¤ (í˜„ì¬ ì“°ëŠ” MG_BASE ê·¸ëŒ€ë¡œ ì‚¬ìš©)
const ESCALATE_PATH = "/api/escalate"; // ì„œë²„ ê²½ë¡œê°€ ë‹¤ë¥´ë©´ ì—¬ê¸°ë§Œ ìˆ˜ì •


â¸»

3-2) CTA ì¹´ë“œ + ì…ë ¥í¼ ë Œë” í•¨ìˆ˜ ì¶”ê°€

add() í•¨ìˆ˜ê°€ ì •ì˜ëœ ì•„ë˜ìª½(ë˜ëŠ” ìœ í‹¸ í•¨ìˆ˜ë“¤ ìˆëŠ” ê³³)ì— ê·¸ëŒ€ë¡œ ë¶™ì—¬ë„£ì–´.

function renderPhoneEscalationCard(payload) {
  // ì¤‘ë³µ ë°©ì§€
  if (document.getElementById("mgEscalateCard")) return;

  add(`
    <div id="mgEscalateCard" class="mgCard" style="border:1px solid rgba(143,175,154,.55); background:rgba(143,175,154,.08);">
      <div style="font-weight:800; margin-bottom:6px;">ì „í™”ìƒë‹´ì´ ë„ì›€ì´ ë  ìˆ˜ ìˆì–´ìš”</div>
      <div style="opacity:.9; line-height:1.5;">
        ì›í•˜ì‹œë©´ <b>24ì‹œê°„ ë‚´</b> ì „í™”ë¡œ ë‹µë³€ì„ ë“œë¦´ê²Œìš”.<br/>
        (ë°©ë¬¸ ìƒë‹´ì€ ì¶”í›„ ì œê³µ ì˜ˆì •ì´ì—ìš”)
      </div>

      <div style="margin-top:10px; display:flex; gap:8px; flex-wrap:wrap;">
        <input id="mgPhone" placeholder="ì „í™”ë²ˆí˜¸ (ì˜ˆ: 010-1234-5678)"
          style="flex:1; min-width:220px; padding:10px 12px; border-radius:12px; border:1px solid rgba(0,0,0,.18);" />

        <input id="mgTime" placeholder="ì—°ë½ ê°€ëŠ¥í•œ ì‹œê°„ (ì„ íƒ)"
          style="flex:1; min-width:220px; padding:10px 12px; border-radius:12px; border:1px solid rgba(0,0,0,.18);" />
      </div>

      <label style="display:block; margin-top:10px; font-size:12px; opacity:.85;">
        <input id="mgConsent" type="checkbox" />
        ì „í™”ìƒë‹´ì„ ìœ„í•´ ì—°ë½ì²˜ ì œê³µì— ë™ì˜í•´ìš”.
      </label>

      <div style="margin-top:10px; display:flex; gap:8px;">
        <button id="mgRequestCall"
          style="flex:1; padding:10px 12px; border-radius:12px; border:0; cursor:pointer; font-weight:900; background:#8FAF9A; color:white;">
          ì „í™”ìƒë‹´ ìš”ì²­í•˜ê¸° (24ì‹œê°„ ë‚´ ì½œë°±)
        </button>

        <button id="mgNoCall"
          style="flex:1; padding:10px 12px; border-radius:12px; border:1px solid rgba(0,0,0,.18); cursor:pointer; background:white; font-weight:800;">
          ì§€ê¸ˆì€ ê´œì°®ì•„ìš”
        </button>
      </div>

      <div style="margin-top:8px; font-size:12px; opacity:.75;">
        â€» ì‘ê¸‰ ìƒí™©(ê³ ì—´Â·ì˜¤í•œÂ·ì‹¬í•œ í†µì¦)ì€ ì˜ë£Œê¸°ê´€ ë„ì›€ì„ ìš°ì„  ê³ ë ¤í•´ìš”.
      </div>
    </div>
  `);

  // ë²„íŠ¼ ì´ë²¤íŠ¸ ë°”ì¸ë”© (í•œ ë²ˆë§Œ)
  const btnReq = document.getElementById("mgRequestCall");
  const btnNo = document.getElementById("mgNoCall");

  if (btnNo) {
    btnNo.onclick = () => {
      const card = document.getElementById("mgEscalateCard");
      if (card) card.remove();
      add(`<div class="mgCard">ì•Œê² ì–´ìš”. ì§€ê¸ˆì€ ë§˜ê³ì´ ì˜†ì—ì„œ ê³„ì† ê°™ì´ ë³¼ê²Œìš”.</div>`);
    };
  }

  if (btnReq) {
    btnReq.onclick = async () => {
      const phone = (document.getElementById("mgPhone")?.value || "").trim();
      const time = (document.getElementById("mgTime")?.value || "").trim();
      const consent = document.getElementById("mgConsent")?.checked;

      if (!consent) {
        add(`<div class="mgCard">ì—°ë½ì²˜ ì œê³µ ë™ì˜ì— ì²´í¬í•´ì£¼ì‹œë©´ ìš”ì²­ì„ ì§„í–‰í•  ìˆ˜ ìˆì–´ìš”.</div>`);
        return;
      }
      if (!phone) {
        add(`<div class="mgCard">ì „í™”ë²ˆí˜¸ë¥¼ í•œ ë²ˆë§Œ ì ì–´ì£¼ì„¸ìš”.</div>`);
        return;
      }

      add(`<div class="mgCard">ì¢‹ì•„ìš”. ìš”ì²­ ë‚´ìš©ì„ ì¡°ìš©íˆ ì „ë‹¬í•˜ê³ , 24ì‹œê°„ ë‚´ ì „í™”ë¡œ ë‹µë³€ë“œë¦´ê²Œìš”.</div>`);

      try {
        const res = await fetch(MG_BASE + ESCALATE_PATH, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            contact_phone: phone,
            preferred_time: time,
            // ìƒë‹´ ë§¥ë½
            context: precheck?.answers || {},
            question: window.__mgLastQuestion || "",
            source: "ebook"
          })
        });

        const data = await res.json().catch(() => ({}));

        if (res.ok) {
          const caseId = data.case_id ? ` (ì ‘ìˆ˜ë²ˆí˜¸: ${esc(data.case_id)})` : "";
          add(`<div class="mgCard">ì ‘ìˆ˜ ì™„ë£Œ${caseId}. ê³§ ì—°ë½ë“œë¦´ê²Œìš”.</div>`);
          // ì¹´ë“œ ì œê±°
          const card = document.getElementById("mgEscalateCard");
          if (card) card.remove();
        } else {
          add(`<div class="mgCard">ìš”ì²­ì„ ì²˜ë¦¬í•˜ëŠ” ì¤‘ ë¬¸ì œê°€ ìƒê²¼ì–´ìš”. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì…”ë„ ê´œì°®ì•„ìš”.</div>`);
        }
      } catch (e) {
        add(`<div class="mgCard">ì—°ê²° ìƒíƒœë¥¼ í™•ì¸í•œ ë’¤ ë‹¤ì‹œ ì‹œë„í•´ ì£¼ì„¸ìš”.</div>`);
      }
    };
  }
}


â¸»

3-3) ask(q)ì—ì„œ ë§ˆì§€ë§‰ ì§ˆë¬¸ ì €ì¥ & escalation ì¹´ë“œ í˜¸ì¶œ

async function ask(q) ì‹œì‘ ë¶€ë¶„ì— ì•„ë˜ í•œ ì¤„ì„ ì¶”ê°€í•´(ì§ˆë¬¸ ì €ì¥ìš©):

window.__mgLastQuestion = q;

ê·¸ë¦¬ê³  ì„œë²„ ì‘ë‹µ ì²˜ë¦¬ í›„, data.suggest_escalation === trueë©´ ì¹´ë“œ ë„ìš°ê¸°:

data.answerë¥¼ ë Œë”ë§í•˜ëŠ” ì½”ë“œ ì•„ë˜ì— ì´ ë¸”ë¡ì„ ì¶”ê°€í•´.

// âœ… ì„œë²„ê°€ ê³ ìœ„í—˜/ì—°ê²° ê¶Œì¥ì„ ë³´ë‚´ë©´ (ì¡°ìš©íˆ) ì „í™”ìƒë‹´ ì¹´ë“œ í‘œì‹œ
if (data && data.suggest_escalation === true) {
  renderPhoneEscalationCard({
    context: precheck?.answers || {},
    question: q
  });
}

ì´ë ‡ê²Œ í•˜ë©´ â€œì¡°ìš©íˆâ€, í•˜ì§€ë§Œ â€œëª…í™•í•˜ê²Œâ€ ì „í™”ìƒë‹´ ìš”ì²­ UIê°€ ëœ¬ë‹¤.

â¸»

(4) âœ… Replit main.py: /api/escalate ë³µë¶™ ì½”ë“œ

ëª©í‘œ
	â€¢	ì „í™”ë²ˆí˜¸/ì‹œê°„ëŒ€/ì§ˆë¬¸/contextë¥¼ ë°›ì•„ì„œ
	â€¢	logs/escalations.jsonlì— ì €ì¥
	â€¢	ë¶„ì„ ë¡œê·¸(analytics.jsonl)ì—ëŠ” ì „í™”ë²ˆí˜¸ ì ˆëŒ€ ì €ì¥í•˜ì§€ ì•ŠìŒ

â¸»

4-1) importsì— ì¶”ê°€

main.py ìƒë‹¨ì— import uuid from datetime import datetime import os import jsonê°€ ì—†ìœ¼ë©´ ì¶”ê°€:

import os, json, uuid
from datetime import datetime


â¸»

4-2) escalation ì €ì¥ í•¨ìˆ˜ + ì—”ë“œí¬ì¸íŠ¸ ì¶”ê°€

/api/query ì•„ë˜ìª½ ì•„ë¬´ ê³³ì— ë¶™ì—¬ë„ ë˜ì§€ë§Œ, ë³´í†µ health/query ì•„ë˜ê°€ ê¹”ë”í•´.

def save_escalation(record: dict):
    os.makedirs("logs", exist_ok=True)
    with open("logs/escalations.jsonl", "a", encoding="utf-8") as f:
        f.write(json.dumps(record, ensure_ascii=False) + "\n")


@app.post("/api/escalate")
def escalate():
    data = request.get_json() or {}

    phone = (data.get("contact_phone") or "").strip()
    preferred_time = (data.get("preferred_time") or "").strip()
    context = data.get("context") or {}
    question = (data.get("question") or "").strip()
    source = data.get("source") or "ebook"

    if not phone:
        return jsonify({"error": "missing_phone"}), 400

    case_id = f"MB-{uuid.uuid4().hex[:8].upper()}"

    # âœ… ê°œì¸ì •ë³´ í¬í•¨ ë¡œê·¸: escalation ì „ìš© íŒŒì¼ë¡œë§Œ ì €ì¥
    record = {
        "ts": datetime.utcnow().isoformat() + "Z",
        "case_id": case_id,
        "source": source,
        "contact_phone": phone,
        "preferred_time": preferred_time,
        "question": question,
        "context": context,
        "status": "received",
        "note": "phone_callback_within_24h"
    }
    save_escalation(record)

    # âœ… ë¶„ì„ ë¡œê·¸ì—ëŠ” ì „í™”ë²ˆí˜¸ ì ˆëŒ€ ì €ì¥í•˜ì§€ ì•ŠìŒ
    # (ì›í•˜ë©´ analyticsì— case_idë§Œ ì—°ê²°í•´ë„ ë¨)
    # log_analytics({ ... "case_id": case_id ... })  # â† phone í¬í•¨ ê¸ˆì§€

    return jsonify({
        "ok": True,
        "case_id": case_id,
        "message": "received"
    }), 200


â¸»

4-3) ìš´ì˜ ë©”ëª¨ (ì§€ê¸ˆì€ 1ì¸ ì „ë¬¸ê°€)
	â€¢	logs/escalations.jsonlì„ ì—´ì–´ì„œ
	â€¢	case_id
	â€¢	ì§ˆë¬¸/ì»¨í…ìŠ¤íŠ¸
	â€¢	ì „í™”ë²ˆí˜¸/ì‹œê°„ëŒ€
ë¥¼ ë³´ê³  ì§ì ‘ ì½œë°±í•˜ë©´ ë¨.

ë‚˜ì¤‘ì—:
	â€¢	Slack ì•Œë¦¼
	â€¢	ì´ë©”ì¼ ì•Œë¦¼
	â€¢	ìº˜ë¦°ë” ì˜ˆì•½
ì´ê±´ ì¶”ê°€ë¡œ ë¶™ì´ë©´ ë.

â¸»

âœ… ì ìš© ìˆœì„œ (ì‹¤ìˆ˜ ë°©ì§€)
	1.	Replit main.pyì— /api/escalate ì¶”ê°€ â†’ Deploy/Republish
	2.	GitHub mg-chat.jsì— renderPhoneEscalationCard + ask() í˜¸ì¶œë¶€ ì¶”ê°€ â†’ Commit
	3.	ì „ìì±… í˜ì´ì§€ì—ì„œ ?v=ìƒˆê°’ìœ¼ë¡œ ì—´ì–´ í…ŒìŠ¤íŠ¸
	4.	ê³ ìœ„í—˜ ì²´í¬(2ê°œ ì´ìƒ) ë§Œë“¤ì–´ì„œ ì „í™”ìƒë‹´ ì¹´ë“œê°€ ëœ¨ëŠ”ì§€ í™•ì¸
	5.	ì „í™”ë²ˆí˜¸ ì…ë ¥ â†’ ì ‘ìˆ˜ë²ˆí˜¸(case_id) ë©”ì‹œì§€ ëœ¨ëŠ”ì§€ í™•ì¸

â¸»

í…ŒìŠ¤íŠ¸ íŒ(ë¹ ë¥´ê²Œ ê³ ìœ„í—˜ ë§Œë“¤ê¸°)

precheckì—ì„œ risk_checkë¥¼ 2ê°œ ì´ìƒ ì„ íƒí•˜ë„ë¡ ìœ ë„í•˜ë©´ ë°”ë¡œ suggest_escalation=trueê°€ ëœ¨ê²Œ í•  ìˆ˜ ìˆì–´(ì„œë²„ ê·œì¹™ì´ 2ê°œ ì´ìƒì¼ ë•Œ trueë‹ˆê¹Œ).

â¸»
