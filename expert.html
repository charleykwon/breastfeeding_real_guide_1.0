<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>맘곁 전문가 케이스 관리</title>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body {
            font-family: 'Noto Sans KR', -apple-system, BlinkMacSystemFont, sans-serif;
            background: #f5f5f5;
            color: #333;
            line-height: 1.6;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        header {
            background: linear-gradient(135deg, #8FAF9A, #E8C9C1);
            color: white;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 20px;
        }
        header h1 { font-size: 1.5rem; font-weight: 700; }
        header p { opacity: 0.9; font-size: 0.9rem; margin-top: 5px; }
        
        .layout {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }
        @media (max-width: 768px) {
            .layout { grid-template-columns: 1fr; }
        }
        @media (max-width: 430px) {
            .container { padding: 12px; }
            header { padding: 16px; border-radius: 10px; margin-bottom: 12px; }
            header h1 { font-size: 1.3rem; }
            .panel { border-radius: 10px; }
            .panel-header { padding: 12px 16px; font-size: 0.95rem; }
            .panel-body { padding: 12px 16px; max-height: 60vh; }
            .case-item { padding: 14px; }
            .case-name { font-size: 1rem; }
            .phone-display { font-size: 1.5rem; padding: 14px 16px; letter-spacing: 1px; }
            .name-display { font-size: 1.3rem; }
            .info-box { padding: 12px; }
            .note-input { font-size: 16px; padding: 14px; min-height: 120px; }
            .btn-save { padding: 16px; font-size: 1rem; }
            .checkbox-row { padding: 14px; }
            .checkbox-row input[type="checkbox"] { width: 22px; height: 22px; }
        }
        
        .panel {
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            overflow: hidden;
        }
        .panel-header {
            background: #fafafa;
            padding: 15px 20px;
            border-bottom: 1px solid #eee;
            font-weight: 700;
            font-size: 1rem;
        }
        .panel-body {
            padding: 15px 20px;
            max-height: 70vh;
            overflow-y: auto;
        }
        
        .case-list { list-style: none; }
        .case-item {
            padding: 12px 15px;
            border-bottom: 1px solid #f0f0f0;
            cursor: pointer;
            transition: background 0.2s;
        }
        .case-item:hover { background: #f9f9f9; }
        .case-item.active { background: #e8f5e9; border-left: 3px solid #8FAF9A; }
        .case-item .case-name { font-weight: 700; color: #333; font-size: 1rem; }
        .case-item .case-phone { font-size: 0.85rem; color: #666; margin-top: 2px; }
        .case-item .case-issue { font-size: 0.8rem; color: #888; margin-top: 4px; }
        .case-item .case-time { font-size: 0.75rem; color: #aaa; margin-top: 4px; }
        .case-item .case-status {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 600;
            margin-left: 8px;
        }
        .status-received { background: #fff3e0; color: #e65100; }
        .status-closed { background: #e8f5e9; color: #2e7d32; }
        
        .detail-empty {
            text-align: center;
            color: #999;
            padding: 40px;
        }
        
        .detail-section {
            margin-bottom: 20px;
        }
        .detail-section h3 {
            font-size: 0.85rem;
            color: #666;
            margin-bottom: 8px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .name-display {
            font-size: 1.5rem;
            font-weight: 700;
            color: #333;
            margin-bottom: 8px;
        }
        .phone-display {
            font-size: 1.8rem;
            font-weight: 700;
            color: #333;
            background: #f5f5f5;
            padding: 15px 20px;
            border-radius: 8px;
            text-align: center;
            letter-spacing: 2px;
        }
        .info-box {
            background: #fafafa;
            padding: 12px 15px;
            border-radius: 8px;
            font-size: 0.9rem;
        }
        .info-row {
            display: flex;
            justify-content: space-between;
            padding: 5px 0;
            border-bottom: 1px solid #eee;
        }
        .info-row:last-child { border-bottom: none; }
        .info-label { color: #666; }
        .info-value { font-weight: 600; }
        
        .question-box {
            background: #fff8e1;
            padding: 15px;
            border-radius: 8px;
            font-size: 0.95rem;
            border-left: 3px solid #ffc107;
        }
        
        .note-input {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 0.9rem;
            resize: vertical;
            min-height: 100px;
            margin-bottom: 15px;
        }
        .note-input:focus {
            outline: none;
            border-color: #8FAF9A;
        }
        
        .checkbox-row {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 15px;
            padding: 12px;
            background: #f9f9f9;
            border-radius: 8px;
        }
        .checkbox-row input[type="checkbox"] {
            width: 20px;
            height: 20px;
            cursor: pointer;
        }
        .checkbox-row label {
            font-weight: 600;
            cursor: pointer;
        }
        
        .btn-save {
            width: 100%;
            padding: 15px 20px;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.2s;
            background: #4caf50;
            color: white;
        }
        .btn-save:hover { background: #43a047; }
        .btn-save:disabled { background: #ccc; cursor: not-allowed; }
        
        .notes-history {
            margin-top: 15px;
            max-height: 150px;
            overflow-y: auto;
        }
        .note-entry {
            background: #f9f9f9;
            padding: 10px 12px;
            border-radius: 6px;
            margin-bottom: 8px;
            font-size: 0.85rem;
        }
        .note-entry .note-time { color: #999; font-size: 0.75rem; margin-bottom: 4px; }
        .note-entry .note-text { color: #333; }
        
        .loading { text-align: center; padding: 40px; color: #999; }
        .error { color: #d32f2f; text-align: center; padding: 20px; }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>맘곁 전문가 케이스 관리</h1>
            <p>전화 상담 요청 목록 · 개인정보 보호 주의</p>
        </header>
        
        <div class="layout">
            <div class="panel">
                <div class="panel-header">케이스 목록 <span id="caseCount"></span></div>
                <div class="panel-body">
                    <div id="caseList" class="loading">불러오는 중...</div>
                </div>
            </div>
            
            <div class="panel">
                <div class="panel-header">케이스 상세</div>
                <div class="panel-body">
                    <div id="caseDetail" class="detail-empty">
                        좌측에서 케이스를 선택해주세요
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const urlParams = new URLSearchParams(window.location.search);
        const EXPERT_KEY = urlParams.get('key') || '';
        
        let cases = [];
        let selectedCase = null;
        
        async function loadCases() {
            const listEl = document.getElementById('caseList');
            try {
                const res = await fetch('/api/expert/cases?key=' + encodeURIComponent(EXPERT_KEY));
                if (!res.ok) throw new Error('Failed to load');
                cases = await res.json();
                renderCaseList();
            } catch (err) {
                listEl.innerHTML = '<div class="error">케이스를 불러올 수 없습니다.</div>';
            }
        }
        
        function renderCaseList() {
            const listEl = document.getElementById('caseList');
            const countEl = document.getElementById('caseCount');
            
            if (cases.length === 0) {
                listEl.innerHTML = '<div class="detail-empty">접수된 케이스가 없습니다.</div>';
                countEl.textContent = '';
                return;
            }
            
            countEl.textContent = '(' + cases.length + '건)';
            
            let html = '<ul class="case-list">';
            cases.forEach(function(c, i) {
                const isActive = selectedCase && selectedCase.case_id === c.case_id;
                const ctx = c.context || {};
                html += '<li class="case-item ' + (isActive ? 'active' : '') + '" onclick="selectCase(' + i + ')">';
                html += '<div>';
                html += '<span class="case-name">' + (c.name || '이름 없음') + '</span>';
                html += '<span class="case-status status-' + (c.status || 'received') + '">' + getStatusLabel(c.status) + '</span>';
                html += '</div>';
                html += '<div class="case-phone">' + (c.contact_phone || '') + '</div>';
                html += '<div class="case-issue">' + (ctx.main_issue || '이슈 미지정') + '</div>';
                html += '<div class="case-time">' + formatTime(c.ts) + '</div>';
                html += '</li>';
            });
            html += '</ul>';
            listEl.innerHTML = html;
        }
        
        function getStatusLabel(status) {
            if (status === 'closed') return '완료';
            return '접수됨';
        }
        
        function formatTime(ts) {
            if (!ts) return '';
            try {
                var d = new Date(ts);
                return d.toLocaleString('ko-KR', { 
                    month: 'short', day: 'numeric', 
                    hour: '2-digit', minute: '2-digit' 
                });
            } catch (e) { return ts; }
        }
        
        function selectCase(index) {
            selectedCase = cases[index];
            renderCaseList();
            renderCaseDetail();
        }
        
        function renderCaseDetail() {
            const detailEl = document.getElementById('caseDetail');
            
            if (!selectedCase) {
                detailEl.innerHTML = '<div class="detail-empty">좌측에서 케이스를 선택해주세요</div>';
                return;
            }
            
            const c = selectedCase;
            const ctx = c.context || {};
            const isResolved = c.status === 'closed';
            
            let html = '';
            
            html += '<div class="detail-section">';
            html += '<div class="name-display">' + (c.name || '이름 없음') + '</div>';
            html += '<div class="phone-display">' + (c.contact_phone || '전화번호 없음') + '</div>';
            html += '</div>';
            
            html += '<div class="detail-section">';
            html += '<h3>케이스 정보</h3>';
            html += '<div class="info-box">';
            html += '<div class="info-row"><span class="info-label">접수 시간</span><span class="info-value">' + formatTime(c.ts) + '</span></div>';
            html += '<div class="info-row"><span class="info-label">아기 나이</span><span class="info-value">' + (ctx.baby_age || '미입력') + '</span></div>';
            html += '<div class="info-row"><span class="info-label">주요 이슈</span><span class="info-value">' + (ctx.main_issue || '미입력') + '</span></div>';
            html += '<div class="info-row"><span class="info-label">위험 신호</span><span class="info-value">' + (ctx.risk_check || '없음') + '</span></div>';
            html += '</div>';
            html += '</div>';
            
            if (c.question) {
                html += '<div class="detail-section">';
                html += '<h3>질문 요약</h3>';
                html += '<div class="question-box">' + c.question + '</div>';
                html += '</div>';
            }
            
            html += '<div class="detail-section">';
            html += '<h3>상담 메모</h3>';
            html += '<textarea id="noteInput" class="note-input" placeholder="상담 내용을 기록하세요...">' + (getLatestNote(c) || '') + '</textarea>';
            html += '</div>';
            
            html += '<div class="checkbox-row">';
            html += '<input type="checkbox" id="resolvedCheck" ' + (isResolved ? 'checked' : '') + '>';
            html += '<label for="resolvedCheck">해결 완료</label>';
            html += '</div>';
            
            html += '<button class="btn-save" onclick="saveAndComplete()">저장 & 완료</button>';
            
            if (c.notes && c.notes.length > 0) {
                html += '<div class="detail-section" style="margin-top:20px">';
                html += '<h3>메모 기록</h3>';
                html += '<div class="notes-history">';
                c.notes.forEach(function(n) {
                    html += '<div class="note-entry">';
                    html += '<div class="note-time">' + formatTime(n.ts) + ' · ' + getStatusLabel(n.status) + '</div>';
                    html += '<div class="note-text">' + (n.expert_note || n.note || '(상태 변경)') + '</div>';
                    html += '</div>';
                });
                html += '</div>';
                html += '</div>';
            }
            
            detailEl.innerHTML = html;
        }
        
        function getLatestNote(c) {
            if (!c.notes || c.notes.length === 0) return '';
            const last = c.notes[c.notes.length - 1];
            return last.expert_note || last.note || '';
        }
        
        async function saveAndComplete() {
            if (!selectedCase) return;
            
            const noteInput = document.getElementById('noteInput');
            const resolvedCheck = document.getElementById('resolvedCheck');
            
            const expertNote = noteInput ? noteInput.value.trim() : '';
            const resolved = resolvedCheck ? resolvedCheck.checked : false;
            
            const body = {
                case_id: selectedCase.case_id,
                expert_note: expertNote,
                resolved: resolved
            };
            
            try {
                const res = await fetch('/api/expert/note?key=' + encodeURIComponent(EXPERT_KEY), {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(body)
                });
                
                if (!res.ok) throw new Error('Failed');
                
                alert(resolved ? '상담이 완료 처리되었습니다.' : '메모가 저장되었습니다.');
                await loadCases();
                
                const idx = cases.findIndex(function(c) { return c.case_id === selectedCase.case_id; });
                if (idx >= 0) {
                    selectCase(idx);
                }
            } catch (err) {
                alert('저장에 실패했습니다.');
            }
        }
        
        loadCases();
    </script>
</body>
</html>
